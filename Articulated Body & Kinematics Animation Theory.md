# Articulated Body & Kinematics Animation Theory 강의 노트

## 1. Kinematics 개요

### 1.1 Kinematics의 정의

- **Kinematics**: 힘(forces)을 고려하지 않고 관절형 피규어(articulated figures)의 움직임을 연구하는 학문
- 골격(skeletons) 애니메이션을 위한 핵심 이론
- 물리학적 요소(힘, 질량 등)를 배제하고 순수한 기하학적 움직임만 다룸

### 1.2 관절형 신체 구조 (Articulated Body Configuration)

#### 골격 구조 (Skeletal Structure)

- **조인트(Joints)**: 회전축 역할을 하는 연결점
- **링크(Links)**: 조인트를 연결하는 강체 부분
- **포즈(Pose)**: 특정 시점에서의 전체 관절 구성
  - 조인트 구성 (Joint configuration)
  - 전역 위치 (Global position)
  - 전역 방향 (Global orientation)

#### 계층적 모델 (Hierarchical Models)

- **트리 구조**: 조인트와 링크로 구성된 계층적 구조
- **루트 링크**: 임의로 선택 가능한 기준점
- **조인트 유형**:
  - **회전 조인트 (Revolute Joint)**: 고정축 주변 회전 허용
  - **프리즈매틱 조인트 (Prismatic Joint)**: 직선을 따라 평행이동 허용
  - **볼-소켓 조인트 (Ball-and-Socket Joint)**: 임의 축 주변 회전 허용

### 1.3 인간 관절의 복잡성

실제 인간 관절은 매우 복잡하며 다양한 형태를 가짐:

- **Plane Joint**: 평면 운동
- **Saddle Joint**: 안장형 관절
- **Ellipsoidal Joint**: 타원형 관절
- **Condyloid Joint**: 과두형 관절
- **Pivot Joint**: 회전축 관절
- **Ball and Socket Joint**: 구관절

## 2. Forward Kinematics vs Inverse Kinematics

### 2.1 Forward Kinematics (순기구학)

```
(p, q) = F(θᵢ)
```

- **입력**: 조인트 각도 (θ₁, θ₂, θ₃, ...)
- **출력**: 말단부(end-effector)의 위치와 방향 (p, q)
- **특징**: 직관적이고 계산이 단순함

### 2.2 Inverse Kinematics (역기구학)

```
θᵢ = F⁻¹(p, q)
```

- **입력**: 목표 위치와 방향 (p, q)
- **출력**: 필요한 조인트 각도 (θ₁, θ₂, θ₃, ...)
- **특징**: 복잡하고 해가 여러 개 존재할 수 있음

## 3. 3D 위치와 방향 표현

### 3.1 표현 방법들

1. **벡터 & 쿼터니언**: `qvq⁻¹ + p`
2. **벡터 & 3x3 행렬**: `Rv + p`
3. **4x4 행렬**:
   ```
   Tv = [R  p] v
        [0  1]
   ```

## 4. Forward Kinematics 상세 분석

### 4.1 2D 로봇 팔 예제

- 2개의 회전 조인트를 가진 간단한 로봇 팔
- 조인트 각도 θ₁, θ₂가 주어졌을 때 말단부 위치 계산:

```
xₑ = l₁cosθ₁ + l₂cos(θ₁ + θ₂)
yₑ = l₁sinθ₁ + l₂sin(θ₁ + θ₂)
```

### 4.2 변환 행렬 (Transformation Matrix)

Forward kinematics는 좌표 변환으로 볼 수 있음:

```
[xₑ]   [0]
[yₑ] = T[0]
[1 ]   [1]
```

여기서 T는 다음과 같은 변환들의 곱:

```
T = (rotθ₁)(transl₁)(rotθ₂)(transl₂)
```

### 4.3 볼-소켓 조인트 처리

3개의 회전 조인트가 한 점에서 교차하는 형태:

- 오일러 각도와 동등
- 임의 축 주변의 3D 회전

### 4.4 플로팅 베이스 (Floating Base)

루트 세그먼트의 위치와 방향을 추가적으로 고려:

```
T = (rotₓ)(translᵧ)(translₒ)(rotθ₁)(transl₁)(rotθ₂)(transl₂)(rotθ₃)
```

### 4.5 조인트 & 링크 변환

- 각 세그먼트는 고유한 좌표계를 가짐
- Forward kinematics는 조인트 변환과 링크 변환의 교대 곱
- 일반적인 형태: `T = J₀L₁J₁L₂J₂L₃J₃`

### 4.6 링크 변환 계산

중립 포즈에서 i번째 조인트와 부모 조인트의 위치/방향을 알 때:

```
Tᵢ₋₁Lᵢ = Tᵢ
Lᵢ = Tᵢ₋₁⁻¹Tᵢ
```

### 4.7 계층적 모델 표현

- **트리 구조**
- **노드**: 조인트 변환 포함
- **아크**: 링크 변환 포함

## 5. Inverse Kinematics 상세 분석

### 5.1 역기구학의 필요성

- **환경과의 상호작용**: 물체 집기, 발을 땅에 놓기 등
- **작업 공간과 상태 공간의 차이**:
  - 캐릭터 포즈: 상태 공간 (조인트 각도)
  - 환경 상호작용: 작업 공간 (데카르트 좌표)

### 5.2 2D 로봇 팔의 역기구학 해석해

목표 위치 (xₑ, yₑ)가 주어졌을 때:

```
cos(θₜ) = xₑ/√(xₑ² + yₑ²)
θₜ = cos⁻¹(xₑ/√(xₑ² + yₑ²))

cos(θₜ - θ₁) = (l₁² + xₑ² + yₑ² - l₂²)/(2l₁√(xₑ² + yₑ²))
θ₁ = θₜ - cos⁻¹((l₁² + xₑ² + yₑ² - l₂²)/(2l₁√(xₑ² + yₑ²)))

cos(π - θ₂) = (l₁² + l₂² - xₑ² - yₑ²)/(2l₁l₂)
θ₂ = π - cos⁻¹((l₁² + l₂² - xₑ² - yₑ²)/(2l₁l₂))
```

### 5.3 인간 팔의 중복성 (Redundancy)

- 같은 목표 위치에 도달하는 여러 가지 방법 존재
- **팔꿈치 회전**: 손목 위치는 동일하지만 팔꿈치 위치 변화
- **어깨 & 손목 회전**: 추가적인 자유도 활용

### 5.4 해석해의 어려움

- **중복성**: 변수 수 > 방정식 수 → 다중해
- **조인트 제한**: 각 변수의 범위 제한
- **도달 가능 작업공간**: 해가 없거나, 유일해, 다중해 존재
- **다중 목표**: 여러 사지가 동시에 제약 조건을 가짐
- **중간 링크 제약**: 말단부뿐만 아니라 중간 링크도 제약 가능

## 6. 반복적 방법 (Iterative Methods)

### 6.1 기본 아이디어

- 모든 조인트를 목표를 향해 반복적으로 이동
- 미소 변화(infinitesimal changes) 고려
- 큰 문제를 작은 단계로 분해

### 6.2 자코비안 (Jacobian) 방법

#### Forward Kinematics Map

```
(x, y) = F(θ₁, θ₂, θ₃)
```

#### 자코비안 행렬

```
[ẋ]     [∂Fₓ/∂θ₁  ∂Fₓ/∂θ₂  ∂Fₓ/∂θ₂] [θ̇₁]
[ẏ] = J [∂Fᵧ/∂θ₁  ∂Fᵧ/∂θ₂  ∂Fᵧ/∂θ₂] [θ̇₂]
                                      [θ̇₃]
```

#### 자코비안 역행렬을 이용한 업데이트

```
[θ₁]       [θ₁]        [θ̇₁]
[θ₂]    =  [θ₂]  + Δt  [θ̇₂]
[θ₃]ₜ₊₁   [θ₃]ₜ       [θ̇₃]ₜ

      [θ₁]           [ẋ]
    = [θ₂]  + ΔtJ⁻¹ [ẏ]
      [θ₃]ₜ          ₜ
```

## 7. 선형 방정식 시스템

### 7.1 시스템 분류

방정식 `Ax = b`에서:

- **미지수 개수**: n (x의 차원)
- **방정식 개수**: m (b의 차원)
- **A**: (m × n) 행렬

#### 경우별 분류

1. **m = n**: 유일해 (LU 분해 사용)
2. **m < n**: 미지정 시스템 (다중해, QR/SVD 분해)
3. **m > n**: 과지정 시스템 (해 없음, QR/SVD 분해)

### 7.2 미지정 선형 시스템 (Under-Specified)

#### 의사역행렬 (Pseudo Inverse)

```
V = (ẋ, ẏ)  and  θ̇ = (θ̇₁, θ̇₂, θ̇₃)
V = Jθ̇
JᵀV = JᵀJθ̇
(JᵀJ)⁻¹JᵀV = (JᵀJ)⁻¹JᵀJθ̇
J⁺V = θ̇

where J⁺ = (JᵀJ)⁻¹Jᵀ
```

### 7.3 물리적 해석

의사역행렬의 기하학적 의미:

- 조인트 각속도를 최소화
- 바깥쪽 링크를 더 많이 움직임
- 시각적 변화 최소화

## 8. 3D에서의 자코비안

### 8.1 선형 및 각속도 관계

회전 조인트로 인한 점의 속도:

```
vₚ = ω × p
ωₚ = ω
```

### 8.2 3D 자코비안 구성

n개의 회전 조인트를 가진 직렬 체인:

```
[vₑₙd₋ₑffₑcₜₒᵣ]     [δθ₁]
[ωₑₙd₋ₑffₑcₜₒᵣ] = J [δθ₂]
                     [ ⋮ ]
                     [δθₙ]

J = [ω₁ × p₁  ω₂ × p₂  ⋯  ωₙ × pₙ]
    [   ω₁       ω₂    ⋯     ωₙ   ]
```

여기서:

- `ωᵢ`: i번째 조인트의 회전축
- `pᵢ`: i번째 조인트에서 말단부까지의 벡터

## 9. 중복성 해결 방법

### 9.1 해 선택 기준

여러 해 중 하나를 선택하는 방법:

- **현재 구성에 가장 가까운 해**
- **의사역행렬**: 조인트 각속도를 (국소적으로) 최소화
- **바깥쪽 링크 우선 이동**: 시각적 변화 최소화
- **최소 시간**: 동역학 고려
- **보조 목표**: 추가 제약 조건
- **자연스러운 외관**: 생체역학 실험 결과 활용

### 9.2 조건수 문제 (Ill-Conditioning)

- 말단부의 작은 변화가 조인트 각도의 큰 변화를 요구할 수 있음
- 특이점 근처에서 수치적 불안정성 발생

### 9.3 특이점 (Singularity)

- 자코비안의 랭크가 변하는 지점
- 특이점 근처에서 조건수가 나빠짐
- 수치적 불안정성의 주요 원인

## 10. 자코비안을 이용한 반복 방법

### 10.1 알고리즘 개요

1. 매 시간 단계마다 자코비안 계산
2. 간단한 오일러 적분 사용
3. 특이점에서 수치적 불안정성 가능

### 10.2 구현 고려사항

- **시간 단계 크기**: 너무 크면 불안정, 너무 작으면 느림
- **수렴 기준**: 목표와의 거리 임계값
- **최대 반복 횟수**: 무한 루프 방지

## 11. 비선형 최적화 (Non-Linear Optimization)

### 11.1 기본 개념

- **비선형 프로그래밍**: 비선형 함수의 (국소) 최솟값 찾기
- **IK의 효율적 해법**: 자코비안 방법보다 강건함
- **다중 목표 처리**: 여러 제약 조건 동시 고려
- **경로 문제**: 자연스럽지 않을 수 있음

### 11.2 정의 요소

- **목적 함수**: 손을 특정 위치에 배치
- **제약 조건**: 조인트 한계, 충돌 방지 등

## 12. 목적 함수 (Objective Function)

### 12.1 위치 목적 함수

```
G(θ) = ||p(θ) - pgoal||²
```

### 12.2 방향 목적 함수

```
G(θ) = ||log(qgoal⁻¹q(θ))||²
```

### 12.3 방향벡터 목적 함수

```
G(θ) = ||v(θ) - vgoal||²
```

## 13. 제약 최적화 (Constrained Optimization)

### 13.1 수학적 정식화

```
Minimize    G(θ)
subject to  lᵢ ≤ θᵢ ≤ uᵢ
```

### 13.2 수치적 기법

- **경사 하강법 (Gradient Descent)**
- **켤레 경사법 (Conjugate Gradient)**
- **순차 이차 프로그래밍 (Sequential Quadratic Programming)**

### 13.3 구현 방법

1. **의사역행렬 + 오일러 적분**: 일정한 시간 단계
2. **방향 선택 + 선 최소화**:
   - 최소 제곱법
   - 경사법
   - 켤레 경사법

## 14. 요약 및 한계

### 14.1 Forward Kinematics 요약

- 운동학은 관절형 피규어의 움직임 연구
- 물리학적 요소(힘, 질량 등) 무시
- Forward kinematics는 직관적이고 계산 간단
- 좌표 변환으로 해석 가능

### 14.2 Inverse Kinematics 요약

- 매우 간단한 구조만 해석적 해 가능
- 복잡한 관절형 피규어는 수치적 해법 필요
- 항상 "올바른" 답을 얻지 못할 수 있음
- 해를 얻은 후 추가적인 조정 필요

### 14.3 실제 적용 시 고려사항

- **초기값 의존성**: 국소 최솟값 문제
- **계산 복잡도**: 실시간 애니메이션에서의 성능
- **안정성**: 특이점 근처에서의 동작
- **자연스러움**: 생체역학적 제약 고려
- **사용자 제어**: 아티스트가 원하는 결과 달성
